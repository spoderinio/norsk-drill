{% extends "base.html" %}

{% block content %}
<div style="max-width: 700px; margin: 0 auto;">
    <h2 style="margin-bottom: 2rem;">Practice Adjectives</h2>

    <!-- Settings -->
    <div class="card" style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem;">Settings</h3>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="auto-play" onchange="updateSettings()">
            <span>üîä Auto-play pronunciation</span>
        </label>
    </div>

    <div class="card" id="practice-card" style="display: none;">
        <div style="text-align: center; margin-bottom: 2rem;">
            <div id="word-display" style="font-size: 2rem; font-weight: 700; display: inline-block;"></div>
            <button 
                onclick="speakWord()" 
                id="speak-btn"
                style="background: none; border: none; font-size: 2rem; cursor: pointer; margin-left: 1rem; vertical-align: middle;"
                title="Listen to pronunciation"
            >
                üîä
            </button>
            
            <!-- Group info -->
            <div id="group-info" style="margin-top: 1rem; display: none;">
                <div style="display: inline-block; background: var(--card-bg); padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem;">
                    üí° <span id="group-text" style="font-weight: 600;"></span>
                    <div id="group-desc" style="margin-top: 0.25rem; color: var(--text-secondary); font-size: 0.8rem;"></div>
                </div>
            </div>
        </div>

        <form id="answer-form" onsubmit="checkAnswer(event);">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Neuter form:</label>
                <input type="text" id="neuter-input" placeholder="Neuter form">
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Plural form:</label>
                <input type="text" id="plural-input" placeholder="Plural form">
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Translation:</label>
                <input type="text" id="translation-input" placeholder="Enter translation">
            </div>

            <div id="feedback" style="margin-bottom: 1rem; padding: 1rem; border-radius: 0.5rem; display: none;"></div>

            <div id="button-container" style="display: flex; gap: 1rem;">
                <button type="submit" class="btn" id="submit-btn" style="flex: 1;">Check Answer</button>
                <button type="button" class="btn btn-secondary" onclick="skipAnswer()" id="skip-btn" style="flex: 1;">Skip ‚è≠Ô∏è</button>
                <button type="button" class="btn btn-secondary" onclick="nextWord()" id="next-btn" style="display: none; flex: 1;">Next Word</button>
            </div>
        </form>
    </div>

    <div id="start-screen" class="card" style="text-align: center;">
        <button class="btn" onclick="startPractice()" style="font-size: 1.2rem; padding: 1.5rem 2rem;">
            Start Practice
        </button>
    </div>

    <div id="stats" style="margin-top: 2rem; text-align: center; color: var(--text-secondary);">
        <span id="correct-count">0</span> correct | 
        <span id="total-count">0</span> total
    </div>
</div>

<script>
let currentAdjective = null;
let seenIds = [];
let correctCount = 0;
let totalCount = 0;

// TTS variables
let norwegianVoice = null;
let voicesLoaded = false;

// Settings
let settings = {
    autoPlay: false
};

// Load TTS voices
function loadVoices() {
    return new Promise((resolve) => {
        const voices = speechSynthesis.getVoices();
        if (voices.length > 0) {
            resolve(voices);
        } else {
            speechSynthesis.onvoiceschanged = () => {
                resolve(speechSynthesis.getVoices());
            };
        }
    });
}

// Initialize TTS
async function initTTS() {
    if (!('speechSynthesis' in window)) {
        console.warn('Speech Synthesis not supported');
        return;
    }
    
    const voices = await loadVoices();
    norwegianVoice = voices.find(v => 
        v.lang === 'nb-NO' || 
        v.lang === 'no-NO' ||
        v.lang.startsWith('nb') ||
        v.lang.startsWith('no')
    );
    
    if (norwegianVoice) {
        console.log('‚úÖ Norwegian voice found:', norwegianVoice.name);
    } else {
        console.log('‚ö†Ô∏è No Norwegian voice, using default');
    }
    
    voicesLoaded = true;
}

// Speak word
function speakWord() {
    if (!currentAdjective || !('speechSynthesis' in window)) return;
    
    speechSynthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(currentAdjective.base);
    
    if (norwegianVoice) {
        utterance.voice = norwegianVoice;
    } else {
        utterance.lang = 'nb-NO';
    }
    
    utterance.rate = 0.75;
    utterance.pitch = 1.0;
    
    speechSynthesis.speak(utterance);
}

// Load settings
function loadSettings() {
    const saved = localStorage.getItem('adjectiveSettings');
    if (saved) {
        settings = JSON.parse(saved);
        document.getElementById('auto-play').checked = settings.autoPlay || false;
    }
}

function updateSettings() {
    settings.autoPlay = document.getElementById('auto-play').checked;
    localStorage.setItem('adjectiveSettings', JSON.stringify(settings));
}

async function startPractice() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('practice-card').style.display = 'block';
    await loadNextWord();
}

async function loadNextWord() {
    try {
        const params = new URLSearchParams();
        if (seenIds.length > 0) {
            params.append('exclude_ids', seenIds.join(','));
        }
        
        const response = await fetch(`/api/adjectives/random?${params}`);
        
        if (!response.ok) {
            if (response.status === 404) {
                alert('No more words available!');
                return;
            }
            throw new Error('Failed to fetch word');
        }
        
        currentAdjective = await response.json();
        seenIds.push(currentAdjective.id);
        
        document.getElementById('word-display').textContent = currentAdjective.base;
        
        // Display group info if available
        const groupInfo = document.getElementById('group-info');
        const groupText = document.getElementById('group-text');
        const groupDesc = document.getElementById('group-desc');
        
        if (currentAdjective.group) {
            groupText.textContent = currentAdjective.group;
            if (currentAdjective.group_description) {
                groupDesc.textContent = currentAdjective.group_description;
                groupDesc.style.display = 'block';
            } else {
                groupDesc.style.display = 'none';
            }
            groupInfo.style.display = 'block';
        } else {
            groupInfo.style.display = 'none';
        }
        
        // Auto-play if enabled
        if (settings.autoPlay && voicesLoaded) {
            setTimeout(() => speakWord(), 300);
        }
        
        // Reset form
        document.getElementById('answer-form').reset();
        document.getElementById('feedback').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'inline-block';
        document.getElementById('skip-btn').style.display = 'inline-block';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('neuter-input').focus();
    } catch (error) {
        console.error('Error loading word:', error);
    }
}

async function checkAnswer(event) {
    event.preventDefault();
    
    const neuterInput = document.getElementById('neuter-input').value;
    const pluralInput = document.getElementById('plural-input').value;
    const translationInput = document.getElementById('translation-input').value;
    
    try {
        const response = await fetch(`/api/adjectives/${currentAdjective.id}/check`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                neuter: neuterInput,
                plural: pluralInput,
                translation: translationInput
            })
        });
        
        const result = await response.json();
        
        totalCount++;
        if (result.all_correct) {
            correctCount++;
        }
        document.getElementById('correct-count').textContent = correctCount;
        document.getElementById('total-count').textContent = totalCount;
        
        displayFeedback(result);
        
    } catch (error) {
        console.error('Error checking answer:', error);
    }
}

function skipAnswer() {
    const result = {
        all_correct: false,
        neuter_correct: false,
        plural_correct: false,
        translation_correct: false,
        correct_neuter: currentAdjective.neuter,
        correct_plural: currentAdjective.plural,
        correct_translations: currentAdjective.translations
    };
    
    totalCount++;
    document.getElementById('correct-count').textContent = correctCount;
    document.getElementById('total-count').textContent = totalCount;
    
    displayFeedback(result);
}

function displayFeedback(result) {
    const feedback = document.getElementById('feedback');
    feedback.style.display = 'block';
    
    if (result.all_correct) {
        feedback.style.background = 'var(--success)';
        feedback.style.color = 'white';
        feedback.innerHTML = '‚úÖ Correct!';
    } else {
        feedback.style.background = 'var(--error)';
        feedback.style.color = 'white';
        let html = '‚ùå Incorrect<br><br>';
        
        if (!result.neuter_correct && result.correct_neuter) {
            html += `Neuter: <strong>${result.correct_neuter}</strong><br>`;
        }
        if (!result.plural_correct && result.correct_plural) {
            html += `Plural: <strong>${result.correct_plural}</strong><br>`;
        }
        if (!result.translation_correct) {
            html += `Translation: <strong>${result.correct_translations.join(', ')}</strong>`;
        }
        
        feedback.innerHTML = html;
    }
    
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('skip-btn').style.display = 'none';
    document.getElementById('next-btn').style.display = 'inline-block';
}

function nextWord() {
    loadNextWord();
}

// Initialize
loadSettings();
initTTS();
</script>
{% endblock %}
